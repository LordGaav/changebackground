#!/usr/bin/env php
<?php
	require_once("changebackground_config.php");
	require_once("changebackground_backends.php");

	$files = glob(IMAGEDIR . "*.{jpg,png}", GLOB_BRACE);
	if ($files === false) {
		exit("Could not open directory");
	}
	if (empty($files)) {
		exit("No image files in directory");
	}

	$random = array();
	while (count($random) < (WORKSPACES * DESKTOPS)) {
		$random[] = rand(0, count($files) - 1);
		$random = array_unique($random, SORT_NUMERIC);
	}
	$random = array_values($random);
	$out = array();

	printf("Found %d images in directory\n", count($files));
	printf("Generated %d random numbers: %s\n", count($random), implode(", ", $random));

	for ($i = 0; $i < WORKSPACES; $i++) {
		if (file_exists("/tmp/background_$i." . FINALEXT) && !unlink ("/tmp/background_$i." . FINALEXT)) {
			exit("Could not remove old background $i");
		}

		$images = array();
		for ($j = 0; $j < DESKTOPS; $j++) {
			$images[] = $files[$random[$j + ($i * DESKTOPS)]];
		}

		$filename = "/tmp/background_$i." . FINALEXT;
		$out[] = $filename;

		printf("Generating %s\n", $filename);

		switch (MONTAGEMODE) {
			case "crop":
				$new_images = array();
				for ($z = 0; $z < count($images); $z++) {
					if (file_exists("/tmp/temp_$z." . TEMPEXT) && !unlink ("/tmp/temp_$z." . TEMPEXT)) {
						exit("Could not remove old temp background $z");
					}

					call_user_func(TEMPMETHOD . "::convert", GEOMETRY, $images[$z], "/tmp/temp_$z." . TEMPEXT);
					$new_images[] = "/tmp/temp_$z." . TEMPEXT;
				}
				$images = $new_images;
			case "scale":
			default:
				call_user_func(FINALMETHOD . "::montage", GEOMETRY, TILES, $images, $filename);
				break;
		}

		printf("Generated %s\n", $filename);
	}

	printf("Executing GConf Compiz hack\n");
	system("gconftool --set /apps/compiz-1/plugins/wallpaper/screen0/options/bg_image \"[" . implode("\",\"", $out) . "]\" --type list --list-type string 2>&1");
	system("gconftool --set /apps/compiz-1/plugins/wallpaper/screen0/options/bg_image_pos \"[1,1,1,1]\" --type list --list-type int 1>&1");
	sleep(2);
	system("gconftool --set /apps/compiz-1/plugins/wallpaper/screen0/options/bg_image_pos \"[2,2,2,2]\" --type list --list-type int 2>&1");
	sleep(2);
	printf("Done @ %s\n", date("H:i:s"));
?>
